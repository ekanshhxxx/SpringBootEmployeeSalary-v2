<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap');

    :root {
      --primary-color: #ffffff;
      --secondary-color: #e6eaf0;
      --accent-color: #004080;
      --text-color: #2c3e50;
      --input-bg: #f9f9f9;
      --border-color: #d1d5db;
      --box-shadow-color: rgba(0, 0, 0, 0.15);
      --button-hover-color: #002d5c;
      --table-header-bg: #004080;
      --table-header-color: #ffffff;
      --table-row-bg: #ffffff;
      --table-row-hover: #f1f5f9;
    }

    body {
      font-family: 'Montserrat', sans-serif;
      background: var(--secondary-color);
      color: var(--text-color);
      margin: 0;
      padding: 30px;
      position: relative;
      min-height: 100vh;
    }

    /* Particles background */
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      background-color: #001f4d;
      z-index: -1;
      top: 0; left: 0;
    }

    h1 {
      font-weight: 700;
      font-size: 2em;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: var(--accent-color);
    }

    h2 {
      font-weight: 600;
      margin-top: 40px;
      margin-bottom: 15px;
      font-size: 1.5em;
      color: var(--accent-color);
    }

    button {
      padding: 8px 16px;
      margin: 2px;
      cursor: pointer;
      border: none;
      border-radius: 50px;
      font-weight: 600;
      transition: background 0.3s ease, transform 0.2s ease;
    }

    button:hover {
      background: var(--button-hover-color);
      color: #fff;
      transform: translateY(-2px);
    }

    .add-btn { background: #28a745; color: #fff; }
    .edit-btn { background: #ffc107; color: #000; }
    .delete-btn { background: #dc3545; color: #fff; }
    .logout-btn {
  background: #762e2e;       /* dark background */
  color: white; /* ensure text is visible */
  float: right;
  padding: 6px 12px;
  margin: 2px;
  cursor: pointer;
  border: none;
  border-radius: 4px;
}


    table {
      width: 100%;
      border-collapse: collapse;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 5px 15px var(--box-shadow-color);
      margin-top: 10px;
    }

    th, td {
      padding: 12px 15px;
      text-align: left;
    }

    th {
      background: var(--table-header-bg);
      color: var(--table-header-color);
    }

    tr {
      background: var(--table-row-bg);
      transition: background 0.2s ease;
    }

    tr:hover {
      background: var(--table-row-hover);
    }

    /* Modal Styling */
    .modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: var(--primary-color);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 15px 50px var(--box-shadow-color);
      max-width: 500px;
      width: 90%;
      z-index: 1000;
    }

    .modal h3 {
      margin-top: 0;
      color: var(--accent-color);
      font-weight: 700;
    }

    .modal button {
      margin-top: 15px;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.4);
      z-index: 999;
    }

    input, select {
      width: 100%;
      padding: 10px 15px;
      margin-bottom: 15px;
      border-radius: 50px;
      border: 1px solid var(--border-color);
      background: var(--input-bg);
      font-size: 1em;
      outline: none;
      box-sizing: border-box;
      transition: border 0.3s ease, box-shadow 0.3s ease;
    }

    input:focus, select:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 10px rgba(0, 64, 128, 0.2);
    }

    h1, h2 {
  /* Gradient text */
  background: linear-gradient(90deg, #1a73e8, #00cfff);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;

  /* Optional: subtle shadow for better visibility */
  text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
}

  </style>
</head>
<body>
<div id="particles-js"></div>

<h1>Admin Dashboard 
  <button class="logout-btn" onclick="logout()">Logout</button>
</h1>

<h2>Departments</h2>
<button class="add-btn" onclick="addDepartment()">+ Add Department</button>
<table id="departmentsTable">
  <thead>
    <tr><th>ID</th><th>Name</th><th>Actions</th></tr>
  </thead>
  <tbody></tbody>
</table>

<h2>Employees</h2>
<button class="add-btn" onclick="addEmployee()">+ Add Employee</button>
<table id="employeesTable">
  <thead>
    <tr><th>ID</th><th>Name</th><th>Email</th><th>Joining Date</th><th>Department</th><th>Actions</th><th>Payroll</th><th>Salary</th></tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Payroll Modal -->
<div id="payrollModal" class="modal">
  <h3>Payroll Details</h3>
  <div id="payrollContent"></div>
  <button onclick="closePayrollModal()">Close</button>
</div>
<div id="modalOverlay" class="modal-overlay"></div>

<!-- Edit Employee Modal -->
<div id="editEmployeeModal" class="modal">
  <h3>Edit Employee</h3>
  <form id="editEmployeeForm">
    <input type="hidden" id="editEmpId">
    <label>Name:</label><br>
    <input type="text" id="editEmpName" required><br>
    <label>Email:</label><br>
    <input type="email" id="editEmpEmail" required><br>
    <label>Joining Date:</label><br>
    <input type="date" id="editEmpJoiningDate" required><br>
    <label>Department ID:</label><br>
    <input type="number" id="editEmpDepartmentId" required><br>
    <button type="submit" class="edit-btn">Save</button>
    <button type="button" onclick="closeEditEmployeeModal()">Cancel</button>
  </form>
</div>
<div id="modalOverlayEdit" class="modal-overlay"></div>

<!-- Salary Components Modal -->
<div id="salaryModal" class="modal">
  <h3>Salary Components</h3>
  <div id="salaryContent"></div>
  <button onclick="closeSalaryModal()">Close</button>
</div>
<div id="modalOverlaySalary" class="modal-overlay"></div>

<script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
<script>
  // Particles.js background
  particlesJS('particles-js', {
    "particles": {
      "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
      "color": { "value": "#ffffff" },
      "shape": { "type": "circle" },
      "opacity": { "value": 0.5 },
      "size": { "value": 3, "random": true },
      "line_linked": { "enable": true, "distance": 150, "color": "#ffffff", "opacity": 0.4, "width": 1 },
      "move": { "enable": true, "speed": 3, "out_mode": "out" }
    },
    "interactivity": {
      "detect_on": "canvas",
      "events": { "onhover": { "enable": true, "mode": "grab" }, "onclick": { "enable": true, "mode": "push" } },
      "modes": { "grab": { "distance": 140, "line_linked": { "opacity": 1 } }, "push": { "particles_nb": 4 } }
    },
    "retina_detect": true
  });

  const token = localStorage.getItem("token");
  if (!token) window.location.href = "index.html";

  const API_BASE = "http://localhost:8081/api";
  const PAYROLL_API = "http://localhost:8082/api";
  let employeesCache = [];

// ------------------ Departments ------------------
async function loadDepartments() {
  const res = await fetch(`${API_BASE}/departments`, { headers: { "Authorization": "Bearer " + token }});
  const data = await res.json();
  const tbody = document.querySelector("#departmentsTable tbody");
  tbody.innerHTML = "";
  data.forEach(d => {
    tbody.innerHTML += `<tr>
        <td>${d.id}</td>
        <td>${d.name}</td>
        <td><button class="delete-btn" onclick="deleteDepartment(${d.id})">Delete</button></td>
      </tr>`;
  });
}
async function addDepartment() {
  const name = prompt("Enter department name:");
  if (!name) return;
  await fetch(`${API_BASE}/departments`, {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
    body: JSON.stringify({ name })
  });
  loadDepartments();
}
async function deleteDepartment(id) {
  if (!confirm("Delete this department?")) return;
  await fetch(`${API_BASE}/departments/${id}`, {
    method: "DELETE",
    headers: { "Authorization": "Bearer " + token }
  });
  loadDepartments();
}

// ------------------ Employees ------------------
async function loadEmployees() {
  const res = await fetch(`${API_BASE}/employees`, { headers: { "Authorization": "Bearer " + token }});
  const data = await res.json();
  employeesCache = data;
  const tbody = document.querySelector("#employeesTable tbody");
  tbody.innerHTML = "";
  data.forEach(e => {
    tbody.innerHTML += `<tr>
        <td>${e.id}</td>
        <td>${e.name}</td>
        <td>${e.email}</td>
        <td>${e.joiningDate}</td>
        <td>${e.department ? e.department.name : "-"}</td>
        <td>
          <button class="edit-btn" onclick="editEmployee(${e.id})">Edit</button>
          <button class="delete-btn" onclick="deleteEmployee(${e.id})">Delete</button>
        </td>
        <td>
          <button class="edit-btn" onclick="viewPayroll(${e.id})">View Payroll</button>
          <button class="add-btn" onclick="generatePayrollPrompt(${e.id})">Generate</button>
        </td>
        <td>
          <button class="edit-btn" onclick="manageSalary(${e.id})">Manage Salary</button>
        </td>
      </tr>`;
  });
}

async function addEmployee() {
  const name = prompt("Enter employee name:");
  const email = prompt("Enter employee email:");
  const joiningDate = prompt("Enter joining date (YYYY-MM-DD):");
  const departmentId = prompt("Enter department ID:");
  if (!name || !email || !joiningDate || !departmentId) return;
  await fetch(`${API_BASE}/employees`, {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
    body: JSON.stringify({ name, email, joiningDate, department: { id: departmentId }})
  });
  loadEmployees();
}

async function deleteEmployee(id) {
  if (!confirm("Delete this employee?")) return;
  await fetch(`${API_BASE}/employees/${id}`, { method: "DELETE", headers: { "Authorization": "Bearer " + token }});
  loadEmployees();
}

// ------------------ Edit Employee ------------------
function editEmployee(empId) {
  const employee = employeesCache.find(e => e.id === empId);
  if (!employee) return;
  document.getElementById("editEmpId").value = employee.id;
  document.getElementById("editEmpName").value = employee.name;
  document.getElementById("editEmpEmail").value = employee.email;
  document.getElementById("editEmpJoiningDate").value = employee.joiningDate;
  document.getElementById("editEmpDepartmentId").value = employee.department ? employee.department.id : '';
  document.getElementById('editEmployeeModal').style.display = 'block';
  document.getElementById('modalOverlayEdit').style.display = 'block';
}
function closeEditEmployeeModal() {
  document.getElementById('editEmployeeModal').style.display = 'none';
  document.getElementById('modalOverlayEdit').style.display = 'none';
}
document.getElementById("editEmployeeForm").addEventListener("submit", async function(e) {
  e.preventDefault();
  const id = document.getElementById("editEmpId").value;
  const name = document.getElementById("editEmpName").value;
  const email = document.getElementById("editEmpEmail").value;
  const joiningDate = document.getElementById("editEmpJoiningDate").value;
  const departmentId = document.getElementById("editEmpDepartmentId").value;
  const res = await fetch(`${API_BASE}/employees/${id}`, {
    method: "PUT",
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
    body: JSON.stringify({ name, email, joiningDate, department: { id: departmentId }})
  });
  if (res.ok) { alert("Employee updated!"); closeEditEmployeeModal(); loadEmployees(); }
  else alert("Error updating employee");
});

// ------------------ Payroll ------------------
async function viewPayroll(empId) {
  const res = await fetch(`${PAYROLL_API}/payroll/${empId}`, { headers: { "Authorization": "Bearer " + token }});
  const payrollData = await res.json();
  if (!payrollData || payrollData.length === 0) {
    showPayrollModal('<p>No payroll records found.</p>');
    return;
  }
  let html = '<table style="width:100%; border-collapse: collapse;"><tr><th>Month</th><th>Total Salary</th><th>Breakdown</th></tr>';
  payrollData.forEach(p => {
    let breakdown = "{}";
    try { breakdown = JSON.stringify(JSON.parse(p.salaryBreakdown), null, 2).replace(/\n/g,"<br>").replace(/ /g,""); } 
    catch(e){}
    html += `<tr><td>${p.month}</td><td>${p.totalSalary}</td><td>${breakdown}</td></tr>`;
  });
  html += '</table>';
  showPayrollModal(html);
}

async function generatePayrollPrompt(empId) {
  const month = prompt("Enter month (YYYY-MM)");
  if (!month) return;
  const res = await fetch(`${PAYROLL_API}/payroll/generate/${empId}?month=${month}`, { method: "POST", headers: { "Authorization": "Bearer " + token }});
  const payroll = await res.json();
  alert(`Payroll generated for ${month}!\nTotal: ${payroll.totalSalary}`);
}

function showPayrollModal(contentHtml) {
  document.getElementById('payrollContent').innerHTML = contentHtml;
  document.getElementById('payrollModal').style.display = 'block';
  document.getElementById('modalOverlay').style.display = 'block';
}
function closePayrollModal() {
  document.getElementById('payrollModal').style.display = 'none';
  document.getElementById('modalOverlay').style.display = 'none';
}

// ------------------ Salary Components ------------------
async function manageSalary(empId) {
  const res = await fetch(`${PAYROLL_API}/employees/${empId}/salary-components`, { headers: { "Authorization": "Bearer " + token }});
  const components = await res.json();
  let html = `<table style="width:100%; border-collapse:collapse;"><tr><th>Name</th><th>Amount</th><th>Actions</th></tr>`;
  components.forEach(c => {
    html += `<tr>
      <td>${c.name}</td>
      <td>${c.amount}</td>
      <td>
        <button onclick="editComponent(${c.id}, ${empId})">Edit</button>
        <button onclick="deleteComponent(${c.id}, ${empId})">Delete</button>
      </td>
    </tr>`;
  });
  html += `</table>
           <button onclick="addComponent(${empId})">+ Add Component</button>
           <button onclick="generatePayrollFromSalaryModal(${empId})" style="margin-left:10px; background:#0077cc; color:white;">Generate Payroll</button>`;
  document.getElementById('salaryContent').innerHTML = html;
  document.getElementById('salaryModal').style.display = 'block';
  document.getElementById('modalOverlaySalary').style.display = 'block';
}

function closeSalaryModal() {
  document.getElementById('salaryModal').style.display = 'none';
  document.getElementById('modalOverlaySalary').style.display = 'none';
}

async function addComponent(empId) {
  const name = prompt("Enter component name:");
  const amount = prompt("Enter amount:");
  if (!name || !amount) return;
  await fetch(`${PAYROLL_API}/employees/${empId}/salary-components`, { 
    method: "POST", 
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token }, 
    body: JSON.stringify({ name, amount: parseFloat(amount) }) 
  });
  manageSalary(empId);
}

async function editComponent(compId, empId) {
  const amount = prompt("Enter new amount:");
  if (!amount) return;
  await fetch(`${PAYROLL_API}/employees/salary-components/${compId}`, { 
    method: "PUT", 
    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token }, 
    body: JSON.stringify({ amount: parseFloat(amount) }) 
  });
  manageSalary(empId);
}

async function deleteComponent(compId, empId) {
  if (!confirm("Delete this component?")) return;
  await fetch(`${PAYROLL_API}/employees/salary-components/${compId}`, { 
    method: "DELETE", 
    headers: { "Authorization": "Bearer " + token } 
  });
  manageSalary(empId);
}

async function generatePayrollFromSalaryModal(empId) {
  const month = prompt("Enter month for payroll (YYYY-MM):");
  if (!month) return;
  const res = await fetch(`${PAYROLL_API}/payroll/generate/${empId}?month=${month}`, { 
    method: "POST", 
    headers: { "Authorization": "Bearer " + token }
  });
  const payroll = await res.json();
  alert(`Payroll generated for ${month}!\nTotal: ${payroll.totalSalary}`);
  manageSalary(empId); // refresh salary components modal
}

// ------------------ Logout ------------------
function logout() { localStorage.removeItem("token"); window.location.href = "index.html"; }

// ------------------ Initialize ------------------
loadDepartments();
loadEmployees();
</script>
</body>
</html>
